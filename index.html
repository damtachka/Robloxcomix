import asyncio
import random
import re
from aiogram import Bot, Dispatcher, types
from aiogram.types import InlineKeyboardButton, InlineKeyboardMarkup
from aiogram.utils import executor

API_TOKEN = '7692548269:AAHSPLfUJBB1r1JVm6D_vF-keshs_PwSTG0'

bot = Bot(token=API_TOKEN)
dp = Dispatcher(bot)

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–µ–π–∫–æ–≤–æ–≥–æ –∫–ª—é—á–∞
def generate_key():
    return f"{random.choice(['T12', 'Q89', 'X77'])}-KIHA{random.randint(10,99)}-{random.randint(10,99)}FALIV{random.randint(0,9)}-X"

# –ò–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞
keyboard = InlineKeyboardMarkup(inline_keyboard=[
    [InlineKeyboardButton(text="–í—ã–±—Ä–∞—Ç—å –∫–ª—é—á –¥–ª—è –∏–≥—Ä", callback_data="choose_game")],
    [InlineKeyboardButton(text="–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á", callback_data="generate_key")]
])

@dp.message_handler(commands=['start'])
async def send_welcome(message: types.Message):
    loading_msg = await message.answer("–ó–∞–≥—Ä—É–∑–∫–∞..")
    await asyncio.sleep(2)
    await loading_msg.edit_text("–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –∫–ª—é—á–∏ –æ—Ç –≤—Å–µ—Ö –¥–≤–µ—Ä–µ–π –≤ —Å—Ç–∏–º —Ç—É—Ç!", reply_markup=keyboard)

@dp.callback_query_handler(lambda c: c.data == 'generate_key')
async def handle_generate_key(callback_query: types.CallbackQuery):
    key = generate_key()
    await bot.send_message(callback_query.from_user.id, f"`{key}`", parse_mode="Markdown")

@dp.callback_query_handler(lambda c: c.data == 'choose_game')
async def handle_choose_game(callback_query: types.CallbackQuery):
    msg = await bot.send_message(callback_query.from_user.id, "–ë–µ–≥—É –∑–∞ –∫–æ–º–∞–Ω–¥–æ–π‚Ä¶‚õπÔ∏è")
    await asyncio.sleep(2)
    await msg.edit_text("–ù–∞–ø–∏—à–∏—Ç–µ —Ç–æ—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏—è –≤–∞—à–µ–π –∏–≥—Ä—ã, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–π —Ö–æ—Ç–∏—Ç–µ –ø—Ä–∏–æ–±—Ä–µ—Å—Ç–∏ –∫–ª—é—á üîë")

    @dp.message_handler()
    async def get_game_name(message: types.Message):
        if re.fullmatch(r'[A-Za-z0-9 ]+', message.text):
            key = generate_key()
            await message.answer(f"`{key}`", parse_mode="Markdown")
        else:
            await message.answer("–ü–æ—Ö–æ–∂–µ, —Ç—ã —Ä–µ—à–∏–ª —Å–æ–∑–¥–∞—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ? –ß—Ç–æ–∂‚Ä¶ —Ç–∞–∫–æ–≥–æ –Ω–µ—Ç—É –≤ —Å—Ç–∏–º–µ..")

if __name__ == '__main__':
    executor.start_polling(dp, skip_updates=True)
